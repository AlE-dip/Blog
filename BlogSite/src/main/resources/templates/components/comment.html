<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<!--/*@thymesVar id="post" type="com.ale.blog.entity.Post"*/-->
<!--/*@thymesVar id="user" type="com.ale.blog.entity.User"*/-->

<div th:fragment="comment(user, post)">
  <div id="comment-service" th:text="${post.getSlug()}"></div>
  <script th:inline="javascript" type="module">
      /*<![CDATA[*/
      import ApiUtil from /*[[@{/js/ApiUtil.js}]]*/ "../../public/js/ApiUtil";

      let isLogin = /*[[${user != null ? true : false}]]*/ false
      let postSlug = /*[[${post.getSlug()}]]*/  ''
      /*]]>*/

      const {createApp} = Vue
      createApp({
          data() {
              return {
                  socket: null,
                  stomp: null,
                  isLogin: isLogin,
                  comments: [],
                  page: 0,
                  totalPage: 0,

                  content: '',
                  replyCommentId: null
              }
          },
          methods: {
              addComment() {
                  axios.post(ApiUtil.commentUrl, {
                      postSlug: postSlug,
                      content: this.content,
                      replyCommentId: this.replyCommentId
                  }, {
                      headers: {
                          'Content-Type': 'application/json',
                      }
                  })
                      .then(response => {
                          console.log(response)
                          this.comments.unshift(response?.data?.data)
                          this.content = ''
                          this.replyCommentId = null
                      })
                      .catch(error => {
                          console.log(error)
                      })
              },
              loadComments(page) {
                  axios.get(ApiUtil.getAllCommentUrl(postSlug, page))
                      .then(response => {
                          console.log(response)
                          this.comments.push(...response?.data?.data?.content)
                          this.page = response?.data?.data?.page
                          this.totalPage = response?.data?.data?.totalPage
                      })
                      .catch(error => {
                          console.log(error)
                      })
              }
          },
          mounted() {
              // this.socket = new SockJS("//localhost:8440/comment")
              let socketUrl = 'ws://localhost:8440/comment'
              this.stomp = new Stomp.client(socketUrl)
              this.stomp.connect(
                  {},
                  frame => {
                      console.log(frame);
                      this.stomp.subscribe(`/topic/post/${postSlug}`, tick => {
                          console.log(tick);
                      });
                  },
                  error => {
                      console.log(error);
                  }
              )

              this.loadComments(0)
          },
          watch: {
              page(value) {
                  this.loadComments(value)
              }
          },
          computed: {
              relyFor() {
                  return this.comments.find(comment => comment.id === this.replyCommentId).username
              }
          },
          template: `
  <div>
    <div class="font-medium text-center text-slate-500 border-b border-slate-200">
      <ul class="flex flex-wrap -mb-px">
        <li class="mr-2">
          <label class="inline-block p-4 text-emerald-600 border-b-2 border-emerald-600 rounded-t-lg">
            Bình luận
          </label>
        </li>
      </ul>
    </div>
    <div v-if="isLogin" class="mt-4 flex justify-between">
      <div class="px-3 py-2 w-full flex items-center mr-3 border rounded bg-slate-50 focus:border-slate-400">
        <div v-if="replyCommentId" class="max-w-[30%] truncate">Trả lời: {{relyFor}}</div>
        <button v-if="replyCommentId" @click="replyCommentId = null"
              class="stroke-slate-500 hover:stroke-emerald-500 mt-1 px-2 border-r border-slate-200" >
          <svg xmlns="http://www.w3.org/2000/svg" focusable="false" viewBox="0 0 24 24" class="min-w-[1rem] min-h-[1rem]">
            <path d="M7 7.00006L17 17.0001M7 17.0001L17 7.00006" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
        <input v-model="content" type="text" placeholder="Thêm bình luận..."
               class="ml-2 grow outline-0 bg-slate-50"/>
      </div>
      <button @click="addComment" class="px-3 py-2 border rounded text-emerald-700 active:text-emerald-900 active:border-emerald-400">
        Đăng
      </button>
    </div>
    <div class="mt-3 border rounded bg-slate-50 max-h-96 overflow-y-auto">

      <div v-for="comment in comments" class="mx-7 my-5 flex items-start">
        <img class="w-10 h-10 rounded-full object-center object-cover"
             src="https://stcv4.hnammobile.com/downloads/f/cach-chup-anh-chan-dung-bang-dien-thoai-lung-linh-nhu-may-anh-01676344756.jpg">
        <div class="ml-3">
          <label class="font-medium truncate">{{comment.username}}</label>
          <div>{{comment.content}}</div>
          <div class="mt-1 text-sm text-slate-500">
            <label>{{comment.createDate}}</label>
            <button @click="replyCommentId = comment.id" class="ml-5">Trả lời</button>
          </div>
          <div v-if="comment.childrenSize > 0" class="mt-2 flex items-center">
            <button class="text-sm text-slate-500">Xem {{comment.childrenSize}} câu trả lời</button>
            <label class="mt-[0.1rem] ml-1 fill-slate-500">
              <svg xmlns="http://www.w3.org/2000/svg" focusable="false" stroke="none" viewBox="0 0 24 24"
                   class="min-w-[1rem] min-h-[1rem]">
                <path fill-rule="evenodd" clip-rule="evenodd"
                      d="M4.29289 8.29289C4.68342 7.90237 5.31658 7.90237 5.70711 8.29289L12 14.5858L18.2929 8.29289C18.6834 7.90237 19.3166 7.90237 19.7071 8.29289C20.0976 8.68342 20.0976 9.31658 19.7071 9.70711L12.7071 16.7071C12.3166 17.0976 11.6834 17.0976 11.2929 16.7071L4.29289 9.70711C3.90237 9.31658 3.90237 8.68342 4.29289 8.29289Z"></path>
              </svg>
            </label>
          </div>
        </div>
      </div>

<!--      <div class="mx-7 my-5 flex items-start">-->
<!--        <img class="w-10 h-10 rounded-full object-center object-cover"-->
<!--             src="https://stcv4.hnammobile.com/downloads/f/cach-chup-anh-chan-dung-bang-dien-thoai-lung-linh-nhu-may-anh-01676344756.jpg">-->
<!--        <div class="ml-3">-->
<!--          <label class="font-medium truncate">Name User</label>-->
<!--          <div>-->
<!--            Comment Use the scale-{percentage}, scale-x-{percentage}, and scale-y-{percentage} utilities to scale-->
<!--            an element. scale-x-{percentage}, and scale-y-{percentage} utilities to scale an element.-->
<!--          </div>-->
<!--          <div class="mt-1 text-sm text-slate-500">-->
<!--            <label>17-10</label>-->
<!--            <button class="ml-5">Trả lời</button>-->
<!--          </div>-->

<!--          <div>-->
<!--            &lt;!&ndash;            Subcomment&ndash;&gt;-->
<!--            <div class="my-5 flex items-start">-->
<!--              <img class="w-7 h-7 rounded-full object-center object-cover"-->
<!--                   src="https://stcv4.hnammobile.com/downloads/f/cach-chup-anh-chan-dung-bang-dien-thoai-lung-linh-nhu-may-anh-01676344756.jpg">-->
<!--              <div class="ml-3">-->
<!--                <label class="font-medium truncate">Name User</label>-->
<!--                <div>-->
<!--                  Comment Use the scale-{percentage}, scale-x-{percentage}, and scale-y-{percentage} utilities to scale-->
<!--                  an element. scale-x-{percentage}, and scale-y-{percentage} utilities to scale an element.-->
<!--                </div>-->
<!--                <div class="mt-1 text-sm text-slate-500">-->
<!--                  <label>17-10</label>-->
<!--                  <button class="ml-5">Trả lời</button>-->
<!--                </div>-->
<!--              </div>-->
<!--            </div>-->

<!--            <div class="my-5 flex items-start">-->
<!--              <img class="w-7 h-7 rounded-full object-center object-cover"-->
<!--                   src="https://stcv4.hnammobile.com/downloads/f/cach-chup-anh-chan-dung-bang-dien-thoai-lung-linh-nhu-may-anh-01676344756.jpg">-->
<!--              <div class="ml-3">-->
<!--                <label class="font-medium truncate">Name User</label>-->
<!--                <div>-->
<!--                  Comment Use the scale-{percentage}, scale-x-{percentage}, and scale-y-{percentage} utilities to scale-->
<!--                  an element. scale-x-{percentage}, and scale-y-{percentage} utilities to scale an element.-->
<!--                </div>-->
<!--                <div class="mt-1 text-sm text-slate-500">-->
<!--                  <label>17-10</label>-->
<!--                  <button class="ml-5">Trả lời</button>-->
<!--                </div>-->
<!--              </div>-->
<!--            </div>-->

<!--          </div>-->

<!--          <div class="mt-2 flex items-center">-->
<!--            <button class="text-sm text-slate-500">Xem thêm 14</button>-->
<!--            <label class="mt-[0.1rem] ml-1 fill-slate-500">-->
<!--              <svg xmlns="http://www.w3.org/2000/svg" focusable="false" stroke="none" viewBox="0 0 24 24"-->
<!--                   class="min-w-[1rem] min-h-[1rem]">-->
<!--                <path fill-rule="evenodd" clip-rule="evenodd"-->
<!--                      d="M4.29289 8.29289C4.68342 7.90237 5.31658 7.90237 5.70711 8.29289L12 14.5858L18.2929 8.29289C18.6834 7.90237 19.3166 7.90237 19.7071 8.29289C20.0976 8.68342 20.0976 9.31658 19.7071 9.70711L12.7071 16.7071C12.3166 17.0976 11.6834 17.0976 11.2929 16.7071L4.29289 9.70711C3.90237 9.31658 3.90237 8.68342 4.29289 8.29289Z"></path>-->
<!--              </svg>-->
<!--            </label>-->
<!--          </div>-->

<!--        </div>-->
<!--      </div>-->
      <div v-if="page < totalPage - 1" class="ml-7 mb-4 flex items-center">
        <button class="text-sm text-slate-500" @click="page++">Xem thêm bình luận</button>
        <label class="mt-[0.1rem] ml-1 fill-slate-500">
          <svg xmlns="http://www.w3.org/2000/svg" focusable="false" stroke="none" viewBox="0 0 24 24"
               class="min-w-[1rem] min-h-[1rem]">
            <path fill-rule="evenodd" clip-rule="evenodd"
                  d="M4.29289 8.29289C4.68342 7.90237 5.31658 7.90237 5.70711 8.29289L12 14.5858L18.2929 8.29289C18.6834 7.90237 19.3166 7.90237 19.7071 8.29289C20.0976 8.68342 20.0976 9.31658 19.7071 9.70711L12.7071 16.7071C12.3166 17.0976 11.6834 17.0976 11.2929 16.7071L4.29289 9.70711C3.90237 9.31658 3.90237 8.68342 4.29289 8.29289Z"></path>
          </svg>
        </label>
      </div>
    </div>
  </div>
          `,
      }).mount("#comment-service")
  </script>
</div>
</html>